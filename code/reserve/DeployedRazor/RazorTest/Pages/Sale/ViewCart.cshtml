@page "{currentPage:int?}"
@using RazorTest.Models
@using Microsoft.AspNetCore.Http
@inject IHttpContextAccessor Accessor
@model RazorTest.Pages.Sale.CartModel
@{
}

<!DOCTYPE html>
<html lang="en">
<!-- partial: Shared/_Head.cshtml -->
@await Html.PartialAsync("Shared/_Head")
<!-- partial -->
<body>
    <div class="container-scroller">
        <!-- partial: Shared/_Sidebar.cshtml -->
        @await Html.PartialAsync("Shared/_Sidebar")
        <!-- partial -->
        <div class="container-fluid page-body-wrapper">
            <!-- partial: Shared/_Navbar.cshtml -->
            @await Html.PartialAsync("Shared/_Navbar")
            <!-- partial -->
            <div class="main-panel">
                <!-- content-wrapper begins -->
                <div class="content-wrapper">
                    <div class="card">
                        <div class="card-body">
                            <!-- EDIT HERE ONLY -->
                            <div class="table-responsive">
                                <div class="card-header text-center">
                                    <h2 class="mb-0">Cart</h2>
                                </div>
                                <table class="table table-hover text-center">
                                    <thead>
                                        <tr>
                                            <th>Product Name</th>
                                            <th>Product Images</th>
                                            <th>Product Type</th>
                                            <th>Product Warranty</th>
                                            <th>Quantity</th>
                                            <th>Unit Price (VND)</th>
                                            <th>Discount Rate</th>
                                            <th>Unit Discount (VND)</th>
                                            <th>Subtotal (VND)</th>
                                            <th>Discount Total (VND)</th>
                                            <th>Total</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var product in Model.Cart)
                                        {
                                            <tr>
                                                <td><strong>@product.ProductName</strong></td>
                                                <td><img src="/ProductImages/@product.ProductImages" width="50px" /></td>
                                                <td>@product.ProductType</td>
                                                <td>@product.ProductWarranty Months</td>
                                                <td>
                                                    <form method="post" asp-page-handler="EditProduct">
                                                        <input type="hidden" name="productId" value="@product.ProductId" />
                                                        <input type="number" name="quantity" value="@product.ProductQuantity" />
                                                    </form>
                                                </td>
                                                <td>@product.UnitPrice.ToString("#,##0")</td>

                                                @if (Model.GetDiscountRateInCart(product.ProductId) > 0)
                                                {
                                                    <td>
                                                        <div style="display: flex;justify-content: center;align-items: center;">
                                                            @(Model.GetDiscountRateInCart(product.ProductId) * 100)%
                                                        </div>

                                                        <form method="post" asp-page-handler="SelectDiscount">
                                                            <input type="hidden" name="productId" value="@product.ProductId" />
                                                            <button type="submit" class="btn btn-outline-warning btn-fw">More</button>
                                                        </form>
                                                    </td>
                                                }
                                                else
                                                {
                                                    <td>
                                                        <form method="post" asp-page-handler="SelectDiscount">
                                                            <input type="hidden" name="productId" value="@product.ProductId" />
                                                            <button type="submit" class="btn btn-outline-warning btn-fw">More</button>
                                                        </form>
                                                    </td>
                                                }

                                                @if (Model.GetDiscountRateInCart(product.ProductId) > 0)
                                                {
                                                    <td>@((Model.GetDiscountRateInCart(product.ProductId) * product.UnitPrice * -1).ToString("#,##0"))</td>
                                                }
                                                else
                                                {
                                                    <td></td>
                                                }

                                                <td>@product.TotalPrice.ToString("#,##0")</td>
                                                @if (Model.GetDiscountRateInCart(product.ProductId) > 0)
                                                {
                                                    <td>@((Model.GetDiscountRateInCart(product.ProductId) * product.UnitPrice * product.ProductQuantity * -1).ToString("#,##0"))</td>
                                                }
                                                else
                                                {
                                                    <td></td>
                                                }
                                                <td>
                                                    @((product.TotalPrice * (1 - Model.GetDiscountRateInCart(product.ProductId))).ToString("#,##0"))

                                                </td>
                                                <td>
                                                    <form method="post" asp-page-handler="Delete" onsubmit="return confirm('Are you sure you want to remove this product?');">
                                                        <input type="hidden" name="productId" value="@product.ProductId" />
                                                        <button type="submit" class="btn btn-outline-danger btn-fw">Delete</button>
                                                    </form>
                                                </td>
                                            </tr>
                                        }
                                        <tr>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td>@Model.SaleInvoiceObject.TotalPrice.ToString("#,##0")</td>
                                            <td>@((Model.SaleInvoiceObject.EndTotalPrice - Model.SaleInvoiceObject.TotalPrice).ToString("#,##0"))</td>
                                            <td>@Model.SaleInvoiceObject.EndTotalPrice.ToString("#,##0")</td>
                                            <td></td>
                                        </tr>

                                    </tbody>
                                </table>
                            </div>

                            <div class="card-body text-center">
                                @if (Model.CurrentPage > 1)
                                {
                                    <a class="btn btn-primary btn-fw" asp-page="./ViewCart" asp-route-currentPage="@(Model.CurrentPage - 1)">&laquo; Prev</a>
                                }
                                @for (var i = 1; i <= Model.TotalPages; i++)
                                {
                                    if (i == Model.CurrentPage)
                                    {
                                        <a class="active btn btn-primary" href="#">@i</a>
                                    }
                                    else
                                    {
                                        <a class="btn btn-primary" asp-page="./ViewCart" asp-route-currentPage="@i">@i</a>
                                    }
                                }
                                @if (Model.CurrentPage < Model.TotalPages)
                                {
                                    <a class="btn btn-primary btn-fw" asp-page="./ViewCart" asp-route-currentPage="@(Model.CurrentPage + 1)">Next &raquo;</a>
                                }
                            </div>

                            <!-- Display customer details if identified -->
                            <div class="table-responsive">
                                <table class="table table-hover text-center ">
                                    <div class="container">
                                        <h2>Customer</h2>
                                    </div>
                                    <form method="post" asp-page-handler="AddCustomer">
                                        <input type="hidden" name="customerId" />
                                        <div class="title">Search Phone Contact</div>
                                        <div class="input-group">
                                            <input type="text" placeholder="Search" name="searchCustomer" value=@Accessor.HttpContext.Session.GetString("_SearchCustomer") />
                                            <div class="input-group-append">
                                                <button class="btn btn-sm btn-outline-primary" type="submit">Search</button>
                                            </div>
                                        </div>
                                        <br />
                                        @if (Model.Customer != null && !Model.Customer.CustomerName.Equals("Not Identified"))
                                        {
                                            <div class="table-responsive">
                                                <table class="table table-hover text-center">
                                                    <tr>
                                                        <th>Name</th>
                                                        <td>@Model.Customer.CustomerName</td>
                                                    </tr>
                                                    <tr>
                                                        <th>Attend Date</th>
                                                        <td>@Model.Customer.AttendDate</td>
                                                    </tr>
                                                    <tr>
                                                        <th>Rank</th>
                                                        <td>@Model.Customer.CustomerRank</td>
                                                    </tr>
                                                    <tr>
                                                        <th>Points</th>
                                                        <td>@Model.Customer.CustomerPoint</td>
                                                    </tr>
                                                </table>
                                            </div>
                                        }
                                    </form>

                                    <!-- Display message when customer is not found -->
                                    @if (!string.IsNullOrEmpty(TempData["Message"]?.ToString()))
                                    {
                                        <div class="alert alert-warning" role="alert">
                                            @TempData["Message"]
                                        </div>
                                    }
                                </table>
                                <form method="get" action="/Sale/CreateCustomer">
                                    <input type="hidden" name="Create" value="/Sale/CreateCustomer" />
                                    <button type="submit" class="btn btn-warning btn-fw" >Add New Customer</button>
                                </form>
                            </div>
                            
                            <div class="card-body text-center">
                                <form method="post" asp-page-handler="Checkout">
                                    <button type="submit" class="btn btn-behance btn-fw">Checkout</button>
                                </form><br/>
                                <a asp-page="./SaleHomePage" class="btn btn-secondary btn-fw">Back</a>
                            </div>
                            <!-- EDIT HERE END -->
                        </div>
                        
                    </div>
                </div>
                <!-- content-wrapper ends -->
                <!-- partial: Shared/_Footer.cshtml -->
                @await Html.PartialAsync("Shared/_Footer")
                <!-- partial -->
            </div>
            <!-- main-panel ends -->
        </div>
        <!-- page-body-wrapper ends -->
    </div>
    <!-- partial: Shared/_Source.cshtml -->
    @await Html.PartialAsync("Shared/_Source")
    <!-- partial -->
</body>
</html>

